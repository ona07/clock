<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=900, initial-scale=1.0">
  <title>函館の天気＆時計</title>
  <meta name="theme-color" content="#1e1e28">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="manifest" href="manifest.webmanifest" type="application/manifest+json">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Roboto:wght@400;700&family=Montserrat:wght@400;600;800&display=swap" rel="stylesheet">
  <style>
    :root {
      --primary-color: #00eaff;
      --secondary-color: #fff176;
      --accent-color: #ff6e40;
      --dark-bg: #1e1e28;
      --card-bg: rgba(30, 30, 40, 0.92);
      --text-color: #ffffff;
      --text-secondary: #aeefff;
      --shadow-color: rgba(31, 38, 135, 0.45);
      --glow-color: rgba(0, 234, 255, 0.44);
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      /* 動くグラデーション背景 */
      background: linear-gradient(135deg, #121212 0%, #1e1e28 50%, #252736 100%);
      background-size: 400% 400%;
      animation: bgMove 20s cubic-bezier(0.4, 0, 0.2, 1) infinite;
      color: var(--text-color);
      font-family: 'Roboto', 'Orbitron', 'Montserrat', Arial, sans-serif;
      margin: 0;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      overflow: hidden;
      position: relative;
      text-rendering: optimizeLegibility;
      -webkit-font-smoothing: antialiased;
    }
    @keyframes bgMove {
      0% { background-position: 0% 50%; }
      25% { background-position: 50% 100%; }
      50% { background-position: 100% 50%; }
      75% { background-position: 50% 0%; }
      100% { background-position: 0% 50%; }
    }
    .container {
      background: var(--card-bg);
      border-radius: 32px;
      box-shadow: 
        0 12px 48px 0 var(--shadow-color), 
        0 1.5px 0 var(--glow-color) inset,
        0 0 80px rgba(0, 0, 0, 0.5);
      padding: 48px 40px 40px 40px;
      display: flex;
      flex-direction: column;
      align-items: center;
      min-width: 340px;
      max-width: 90vw;
      position: relative;
      overflow: visible;
      border: 2.5px solid rgba(0, 234, 255, 0.12);
      backdrop-filter: blur(4px);
      transform: perspective(1000px) rotateX(2deg) rotateY(-1deg);
      transition: all 0.7s cubic-bezier(0.34, 1.56, 0.64, 1);
      z-index: 10;
      transform-style: preserve-3d;
    }

    .container:hover {
      transform: perspective(1000px) rotateX(0deg) rotateY(0deg) translateY(-10px) scale(1.02);
      box-shadow: 
        0 25px 65px 0 var(--shadow-color), 
        0 2px 0 var(--glow-color) inset,
        0 0 120px rgba(0, 0, 0, 0.7);
    }
    
    .container::after {
      content: "";
      position: absolute;
      inset: 0;
      border-radius: 32px;
      background: linear-gradient(125deg, 
        rgba(255, 255, 255, 0.12) 0%, 
        rgba(255, 255, 255, 0.08) 15%, 
        rgba(255, 255, 255, 0) 30%);
      z-index: 1;
      pointer-events: none;
    }

    /* Neon border effect */
    .container::before {
      content: "";
      position: absolute;
      top: -2px;
      left: -2px;
      right: -2px;
      bottom: -2px;
      border-radius: 34px;
      background: linear-gradient(45deg, 
        var(--primary-color), 
        transparent 20%,
        transparent 80%,
        var(--secondary-color));
      z-index: -1;
      filter: blur(12px);
      opacity: 0.5;
      transition: opacity 0.5s;
      animation: borderGlow 8s linear infinite;
    }

    @keyframes borderGlow {
      0% { opacity: 0.3; filter: blur(12px); }
      50% { opacity: 0.6; filter: blur(8px); }
      100% { opacity: 0.3; filter: blur(12px); }
    }
    .clock {
      font-family: 'Orbitron', 'Montserrat', monospace;
      font-size: 3.8rem;
      font-weight: 900;
      letter-spacing: 0.13em;
      margin-bottom: 16px;
      color: var(--clock-color, #fff);
      text-shadow:
        0 2px 8px #0008,
        0 0 16px var(--clock-color, var(--primary-color)),
        0 0 32px var(--glow-color),
        0 0 2px #fff,
        0 8px 32px rgba(0, 234, 255, 0.22);
      position: relative;
      z-index: 2;
      background-clip: text;
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-image: linear-gradient(
        90deg,
        var(--primary-color) 0%,
        #ffffff 50%,
        var(--secondary-color) 100%
      );
      background-size: 200% auto;
      transform-style: preserve-3d;
      transition: all 0.8s cubic-bezier(0.23, 1, 0.32, 1);
      filter: drop-shadow(0 0 16px rgba(0, 234, 255, 0.6));
      /* 横幅固定化 */
      min-width: 9.2ch; /* 00:00:00 で7+2=9文字分 */
      display: inline-block;
      text-align: center;
      /* Combined animations with proper properties */
      animation-name: glow, fadeInUp, clockPulse, textShine, clockFloat;
      animation-duration: 2s, 1s, 4s, 6s, 8s;
      animation-timing-function: alternate, cubic-bezier(0.23, 1, 0.32, 1), ease-in-out, linear, ease-in-out;
      animation-delay: 0s, 0.1s, 0s, 0s, 0s;
      animation-iteration-count: infinite, 1, infinite, infinite, infinite;
      animation-fill-mode: none, both, none, none, none;
    }
    
    /* 3D perspective effect for clock digits */
    .clock span {
      display: inline-block;
      transform-style: preserve-3d;
      animation: digitPulse 3s ease-in-out infinite;
      animation-delay: calc(var(--digit-index, 0) * 0.1s);
    }
    
    @keyframes digitPulse {
      0%, 100% { transform: translateZ(0px); }
      50% { transform: translateZ(10px) translateY(-2px); }
    }
    
    @keyframes clockFloat {
      0% { transform: translateY(0) rotate(-0.5deg); }
      50% { transform: translateY(-5px) rotate(0.5deg); }
      100% { transform: translateY(0) rotate(-0.5deg); }
    }

    @keyframes textShine {
      0% { background-position: 0% center; }
      100% { background-position: 200% center; }
    }
    .temp-bar {
      width: 80%;
      height: 8px;
      border-radius: 10px;
      margin-bottom: 14px;
      background: linear-gradient(90deg, var(--primary-color) 0%, var(--secondary-color) 100%);
      box-shadow: 
        0 2px 12px rgba(0, 234, 255, 0.44), 
        0 0 8px rgba(255, 241, 118, 0.44),
        0 0 20px var(--primary-color);
      transition: all 0.7s cubic-bezier(0.34, 1.56, 0.64, 1);
      position: relative;
      z-index: 2;
      opacity: 0.92;
      overflow: hidden;
    }

    .temp-bar::before {
      content: "";
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.4), transparent);
      animation: tempBarShine 3s ease-in-out infinite;
    }

    @keyframes tempBarShine {
      0% { left: -100%; }
      50% { left: 100%; }
      100% { left: 100%; }
    }
    @keyframes clockPulse {
      0% { transform: scale(1) rotate(-0.5deg); filter: brightness(1); }
      25% { transform: scale(1.03) rotate(0.5deg); filter: brightness(1.2); }
      50% { transform: scale(1.01) rotate(-0.5deg); filter: brightness(1); }
      75% { transform: scale(1.04) rotate(0.5deg); filter: brightness(1.15); }
      100% { transform: scale(1) rotate(-0.5deg); filter: brightness(1); }
    }
    .clock::after {
      /* 反射エフェクト */
      content: "";
      display: block;
      position: absolute;
      left: 10%;
      top: 0;
      width: 80%;
      height: 40%;
      background: linear-gradient(120deg, #fff8 0%, #fff2 100%);
      opacity: 0.18;
      border-radius: 50% 50% 40% 40%/60% 60% 40% 40%;
      pointer-events: none;
      z-index: 1;
      filter: blur(2px);
      animation: glassReflect 2.8s linear infinite;
    }
    @keyframes glassReflect {
      0% { left: 10%; opacity: 0.18; }
      40% { left: 60%; opacity: 0.28; }
      60% { left: 60%; opacity: 0.28; }
      100% { left: 10%; opacity: 0.18; }
    }
    @keyframes glow {
      from { text-shadow: 0 2px 8px #0008, 0 0 10px #00eaff44; }
      to   { text-shadow: 0 2px 16px #00eaffcc, 0 0 20px #00eaff88; }
    }
    @keyframes fadeInUp {
      from {
        opacity: 0;
        transform: translate3d(0, 40px, 0);
      }
      to {
        opacity: 1;
        transform: none;
      }
    }
    .date {
      font-size: 1.35rem;
      font-weight: 600;
      color: var(--text-secondary);
      margin-bottom: 18px;
      letter-spacing: 0.1em;
      animation: 
        fadeInUp 1s cubic-bezier(0.23, 1, 0.32, 1) 0.3s both, 
        dateGlow 2.5s infinite alternate,
        datePulse 8s ease-in-out infinite;
      text-shadow: 0 1px 8px rgba(0, 234, 255, 0.27), 0 0 2px #fff;
      font-family: 'Montserrat', 'Roboto', Arial, sans-serif;
      filter: drop-shadow(0 0 4px rgba(255, 241, 118, 0.27));
      position: relative;
      padding: 0 12px;
    }
    
    .date::before, .date::after {
      content: "〔";
      position: absolute;
      left: -10px;
      top: 0;
      color: var(--secondary-color);
      opacity: 0.7;
      text-shadow: 0 0 8px var(--primary-color);
      animation: bracketPulse 3s infinite alternate;
    }
    
    .date::after {
      content: "〕";
      left: auto;
      right: -10px;
    }
    
    @keyframes bracketPulse {
      0% { opacity: 0.3; transform: scale(0.8); }
      100% { opacity: 0.8; transform: scale(1.1); }
    }
    
    @keyframes datePulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.03); }
      100% { transform: scale(1); }
    }
    @keyframes dateGlow {
      from { text-shadow: 0 1px 8px #00eaff44, 0 0 2px #fff; }
      to   { text-shadow: 0 1px 16px #fff176cc, 0 0 8px #00eaff88; }
    }
    .weather {
      display: flex;
      align-items: center;
      gap: 24px;
      margin-bottom: 20px;
      padding: 18px 24px;
      background: rgba(0, 0, 0, 0.2);
      border-radius: 18px;
      box-shadow: 
        0 8px 32px rgba(0, 0, 0, 0.2),
        0 1px 0 rgba(255, 255, 255, 0.05) inset;
      animation: 
        fadeInUp 1s cubic-bezier(0.23, 1, 0.32, 1) 0.5s both, 
        weatherFloat 5s ease-in-out infinite;
      position: relative;
      z-index: 2;
      backdrop-filter: blur(4px);
      border: 1px solid rgba(255, 255, 255, 0.05);
      transform: perspective(800px) rotateY(-2deg);
      transition: all 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);
    }
    
    .weather:hover {
      transform: perspective(800px) rotateY(0deg) translateY(-5px);
      box-shadow: 
        0 12px 36px rgba(0, 0, 0, 0.3),
        0 1px 0 rgba(255, 255, 255, 0.1) inset;
    }
    
    /* Weather card glass effect */
    .weather::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 50%;
      background: linear-gradient(to bottom, 
        rgba(255, 255, 255, 0.1) 0%, 
        rgba(255, 255, 255, 0) 100%);
      border-radius: 18px 18px 0 0;
      pointer-events: none;
    }
    @keyframes weatherFloat {
      0% { transform: perspective(800px) rotateY(-2deg) translateY(0); }
      50% { transform: perspective(800px) rotateY(-2deg) translateY(-8px) rotateZ(0.3deg); }
      100% { transform: perspective(800px) rotateY(-2deg) translateY(0); }
    }
    .weather-icon {
      width: 70px;
      height: 70px;
      filter: drop-shadow(0 2px 12px rgba(0, 234, 255, 0.8)) drop-shadow(0 0 24px rgba(255, 241, 118, 0.4));
      animation: 
        fadeInUp 1s cubic-bezier(0.23, 1, 0.32, 1) 0.7s both, 
        iconPulse 2.5s infinite alternate,
        iconFloat 6s ease-in-out infinite;
      transition: transform 0.3s cubic-bezier(0.23, 1, 0.32, 1), filter 0.3s;
      position: relative;
      z-index: 2;
      cursor: pointer;
    }

    @keyframes iconFloat {
      0% { transform: translateY(0) rotate(0deg); }
      50% { transform: translateY(-8px) rotate(3deg); }
      100% { transform: translateY(0) rotate(0deg); }
    }
    @keyframes iconPulse {
      0% { 
        filter: drop-shadow(0 2px 12px rgba(0, 234, 255, 0.8)) 
                drop-shadow(0 0 24px rgba(255, 241, 118, 0.4));
      }
      100% { 
        filter: drop-shadow(0 2px 24px rgba(255, 241, 118, 0.8)) 
                drop-shadow(0 0 48px rgba(0, 234, 255, 0.8));
      }
    }
    .weather-icon:hover {
      transform: scale(1.25) rotate(-10deg);
      filter: drop-shadow(0 2px 32px rgba(255, 241, 118, 0.8)) 
              drop-shadow(0 0 64px rgba(0, 234, 255, 0.8));
      animation-play-state: paused;
    }

    .weather-icon:active {
      transform: scale(0.95) rotate(5deg);
      transition: transform 0.1s;
    }
    .weather-info {
      display: flex;
      flex-direction: column;
      align-items: flex-start;
      gap: 2px;
    }
    .temp {
      font-size: 2.4rem;
      font-weight: 800;
      line-height: 1;
      background: linear-gradient(90deg, var(--primary-color) 0%, var(--secondary-color) 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      text-shadow: 0 2px 8px rgba(0, 234, 255, 0.27), 0 0 12px rgba(255, 241, 118, 0.27), 0 0 2px #fff;
      animation: 
        fadeInUp 1s cubic-bezier(0.23, 1, 0.32, 1) 0.9s both, 
        tempGlow 3s infinite alternate,
        tempFloat 7s ease-in-out infinite;
      font-family: 'Orbitron', 'Montserrat', monospace;
      position: relative;
      transform-style: preserve-3d;
      /* 横幅固定化 */
      min-width: 6.5ch; /* -99.9℃ で6文字分 */
      display: inline-block;
      text-align: right;
    }
    
    .temp::after {
      content: "℃";
      position: absolute;
      right: -1rem;
      top: 0.2rem;
      font-size: 1.2rem;
      opacity: 0.9;
      transform: translateZ(-10px);
    }
    
    @keyframes tempFloat {
      0% { transform: translateX(0) skew(0deg); }
      50% { transform: translateX(3px) skew(-1deg); }
      100% { transform: translateX(0) skew(0deg); }
    }
    @keyframes tempGlow {
      from { text-shadow: 0 2px 8px #00eaff44, 0 0 12px #fff17644, 0 0 2px #fff;}
      to   { text-shadow: 0 2px 24px #fff176cc, 0 0 24px #00eaffcc, 0 0 8px #fff;}
    }
    .desc {
      font-size: 1.2rem;
      color: var(--text-secondary);
      margin-top: 4px;
      letter-spacing: 0.08em;
      padding: 2px 10px;
      border-radius: 20px;
      background: rgba(0, 234, 255, 0.1);
      display: inline-block;
      animation: 
        fadeInUp 1s cubic-bezier(0.23, 1, 0.32, 1) 1.1s both, 
        descGlow 2.5s infinite alternate,
        descPulse 6s ease-in-out infinite;
      text-shadow: 0 1px 8px rgba(0, 234, 255, 0.27), 0 0 2px #fff;
      font-family: 'Montserrat', 'Roboto', Arial, sans-serif;
      border: 1px solid rgba(0, 234, 255, 0.2);
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
    }
    
    @keyframes descPulse {
      0% { transform: translateX(0) scale(1); background: rgba(0, 234, 255, 0.1); }
      50% { transform: translateX(3px) scale(1.02); background: rgba(255, 241, 118, 0.1); }
      100% { transform: translateX(0) scale(1); background: rgba(0, 234, 255, 0.1); }
    }
    @keyframes descGlow {
      from { text-shadow: 0 1px 8px #00eaff44, 0 0 2px #fff;}
      to   { text-shadow: 0 1px 16px #fff176cc, 0 0 8px #00eaff88;}
    }
    .footer {
      margin-top: 28px;
      font-size: 1rem;
      color: var(--text-secondary);
      text-align: center;
      opacity: 0.8;
      letter-spacing: 0.08em;
      text-shadow: 0 1px 8px rgba(0, 234, 255, 0.27), 0 0 2px #fff;
      font-family: 'Montserrat', 'Roboto', Arial, sans-serif;
      filter: drop-shadow(0 0 4px rgba(255, 241, 118, 0.27));
      transition: all 0.3s ease;
      background: rgba(0, 0, 0, 0.2);
      padding: 10px 20px;
      border-radius: 24px;
      border-top: 1px solid rgba(255, 255, 255, 0.05);
      animation: footerGlow 4s infinite alternate;
    }
    
    @keyframes footerGlow {
      0% { box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2); }
      100% { box-shadow: 0 2px 15px rgba(0, 234, 255, 0.2), 0 2px 5px rgba(255, 241, 118, 0.1); }
    }
    .footer a {
      color: var(--secondary-color);
      text-shadow: 0 0 8px rgba(0, 234, 255, 0.53);
      transition: all 0.3s ease;
      text-decoration: none;
      position: relative;
      padding: 0 4px;
    }
    
    .footer a:hover {
      color: var(--primary-color);
      text-shadow: 0 0 16px rgba(255, 241, 118, 0.8);
    }
    
    .footer a::after {
      content: '';
      position: absolute;
      width: 100%;
      height: 1px;
      bottom: -2px;
      left: 0;
      background: linear-gradient(90deg, transparent, var(--secondary-color), transparent);
      transform: scaleX(0);
      transform-origin: center;
      transition: transform 0.3s ease;
    }
    
    .footer a:hover::after {
      transform: scaleX(1);
    }
    @media (max-width: 500px) {
      .container { padding: 20px 6vw; }
      .clock { font-size: 2rem; }
      .weather-icon { width: 40px; height: 40px; }
      .temp { font-size: 1.3rem; }
      .footer { font-size: 0.8rem; }
      .date { font-size: 1rem; }
      .desc { font-size: 0.9rem; }
      .weather { padding: 12px 16px; }
    }
    
    /* Page hover effects */
    body::before {
      content: '';
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: radial-gradient(circle at center, transparent, rgba(0, 0, 0, 0.5));
      opacity: 0;
      transition: opacity 1s ease;
      pointer-events: none;
      z-index: 1;
    }
    
    body:hover::before {
      opacity: 1;
    }
  </style>
  <link rel="apple-touch-icon" href="icons/icon-192.png">
  <meta name="theme-color" content="#1e1e28">
  <script>
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', function() {
        navigator.serviceWorker.register('service-worker.js').then(function(registration) {
          console.log('ServiceWorker registration successful with scope: ', registration.scope);
        }, function(err) {
          console.log('ServiceWorker registration failed: ', err);
        });
      });
    }
  </script>
</head>
<body>
  <div class="container">
    <!-- パーティクル背景 -->
    <canvas id="particle-bg" style="position:absolute;left:0;top:0;width:100%;height:100%;z-index:0;pointer-events:none;"></canvas>
    <div class="clock" id="clock">--:--:--</div>
    <div class="temp-bar" id="temp-bar"></div>
    <div class="date" id="date">----/--/--（-）</div>
    <div class="weather" id="weather">
      <div class="weather-icon" id="weather-icon"></div>
      <div class="weather-info">
        <div class="temp" id="temp">--℃</div>
        <div class="desc" id="desc">天気情報取得中...</div>
      </div>
    </div>
    <div class="footer">
      函館の天気＆時計<br>
      Powered by <a href="https://open-meteo.com/" target="_blank">Open-Meteo</a>
    </div>
  </div>
  <script>
    // Clock & Date
    function updateClockAndDate() {
      const now = new Date();
      const h = String(now.getHours()).padStart(2, '0');
      const m = String(now.getMinutes()).padStart(2, '0');
      const s = String(now.getSeconds()).padStart(2, '0');
      document.getElementById('clock').textContent = `${h}:${m}:${s}`;
      // 日付と曜日
      const y = now.getFullYear();
      const mon = now.getMonth() + 1;
      const d = now.getDate();
      const days = ['日', '月', '火', '水', '木', '金', '土'];
      const w = days[now.getDay()];
      document.getElementById('date').textContent = `${y}/${mon}/${d}（${w}）`;
    }
    setInterval(updateClockAndDate, 1000);
    updateClockAndDate();

    // 毎秒アニメーション：時計の色を1秒ごとに変化
    const clockColors = [
      "#00eaff", "#fff176", "#ff8a65", "#aeefff", "#ffd600", "#90caf9", "#ffb300"
    ];
    let colorIdx = 0;
    function animateClockColor() {
      colorIdx = (colorIdx + 1) % clockColors.length;
      document.documentElement.style.setProperty('--clock-color', clockColors[colorIdx]);
    }
    setInterval(animateClockColor, 1000);
    // 初期色
    document.documentElement.style.setProperty('--clock-color', clockColors[0]);

    // パーティクル背景
    function createParticles() {
      const canvas = document.getElementById('particle-bg');
      if (!canvas) return;
      const ctx = canvas.getContext('2d');
      let w = canvas.width = canvas.offsetWidth;
      let h = canvas.height = canvas.offsetHeight;
      let particles = [];
      const colors = ["#00eaff", "#fff176", "#ff8a65", "#aeefff", "#ffd600", "#90caf9", "#ffb300"];
      for (let i = 0; i < 36; i++) {
        particles.push({
          x: Math.random() * w,
          y: Math.random() * h,
          r: Math.random() * 1.8 + 1.2,
          c: colors[Math.floor(Math.random() * colors.length)],
          vx: (Math.random() - 0.5) * 0.4,
          vy: (Math.random() - 0.5) * 0.4,
          a: Math.random() * 0.5 + 0.3
        });
      }
      function draw() {
        ctx.clearRect(0, 0, w, h);
        for (let p of particles) {
          ctx.globalAlpha = p.a;
          ctx.beginPath();
          ctx.arc(p.x, p.y, p.r, 0, Math.PI * 2);
          ctx.fillStyle = p.c;
          ctx.shadowColor = p.c;
          ctx.shadowBlur = 12;
          ctx.fill();
          ctx.shadowBlur = 0;
          p.x += p.vx;
          p.y += p.vy;
          if (p.x < 0) p.x = w;
          if (p.x > w) p.x = 0;
          if (p.y < 0) p.y = h;
          if (p.y > h) p.y = 0;
        }
        ctx.globalAlpha = 1;
        requestAnimationFrame(draw);
      }
      draw();
      window.addEventListener('resize', () => {
        w = canvas.width = canvas.offsetWidth;
        h = canvas.height = canvas.offsetHeight;
      });
    }
    window.addEventListener('DOMContentLoaded', createParticles);

    // 函館市の座標
    const lat = 41.7687;
    const lon = 140.7288;

    // Weather fetch
    async function fetchWeather() {
      const url = `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current_weather=true&timezone=Asia%2FTokyo`;
      try {
        const res = await fetch(url);
        const data = await res.json();
        const weather = data.current_weather;
        const temp = Math.round(weather.temperature * 10) / 10;
        const code = weather.weathercode;
        document.getElementById('temp').textContent = `${temp}℃`;
        document.getElementById('desc').textContent = getWeatherDesc(code);
        const iconSVG = getWeatherIconSVG(code);
        const iconEl = document.getElementById('weather-icon');
        iconEl.innerHTML = iconSVG;
        // --- 追加: 気温バーの色・幅を動的に変更 ---
        const tempBar = document.getElementById('temp-bar');
        if (tempBar) {
          // 気温-20℃〜35℃を0〜1に正規化
          let norm = Math.max(0, Math.min(1, (temp + 10) / 45));
          // 色グラデーション（寒色→暖色）
          const cold = [0, 234, 255];
          const hot = [255, 193, 7];
          const r = Math.round(cold[0] + (hot[0] - cold[0]) * norm);
          const g = Math.round(cold[1] + (hot[1] - cold[1]) * norm);
          const b = Math.round(cold[2] + (hot[2] - cold[2]) * norm);
          tempBar.style.background = `linear-gradient(90deg, rgb(${r},${g},${b}) 0%, #fff176 100%)`;
          tempBar.style.width = `${60 + 40 * norm}%`;
        }
      } catch (e) {
        document.getElementById('temp').textContent = '--℃';
        document.getElementById('desc').textContent = '天気情報取得失敗';
        document.getElementById('weather-icon').innerHTML = '';
      }
    }

    // Weather code to description
    function getWeatherDesc(code) {
      if (code === 0) return "快晴";
      if (code === 1 || code === 2) return "晴れ";
      if (code === 3) return "曇り";
      if (code >= 45 && code <= 48) return "霧";
      if (code >= 51 && code <= 57) return "霧雨";
      if (code >= 61 && code <= 67) return "雨";
      if (code >= 71 && code <= 77) return "雪";
      if (code >= 80 && code <= 82) return "にわか雨";
      if (code >= 85 && code <= 86) return "にわか雪";
      if (code === 95) return "雷雨";
      if (code === 96 || code === 99) return "激しい雷雨";
      return "不明";
    }

    // Weather code to SVG icon
    function getWeatherIconSVG(code) {
      // シンプルなSVGアイコンを天気コードごとに返す
      if (code === 0) { // 快晴
        return `<svg width="90" height="90" viewBox="0 0 90 90" fill="none"><circle cx="45" cy="45" r="24" fill="#ffe066" stroke="#fff176" stroke-width="6"/><g stroke="#ffe066" stroke-width="4"><line x1="45" y1="10" x2="45" y2="0"/><line x1="45" y1="80" x2="45" y2="90"/><line x1="10" y1="45" x2="0" y2="45"/><line x1="80" y1="45" x2="90" y2="45"/><line x1="20" y1="20" x2="10" y2="10"/><line x1="70" y1="20" x2="80" y2="10"/><line x1="20" y1="70" x2="10" y2="80"/><line x1="70" y1="70" x2="80" y2="80"/></g></svg>`;
      }
      if (code === 1 || code === 2) { // 晴れ
        return `<svg width="90" height="90" viewBox="0 0 90 90" fill="none"><circle cx="45" cy="45" r="24" fill="#ffe066" stroke="#fff176" stroke-width="6"/><ellipse cx="65" cy="65" rx="18" ry="10" fill="#b3e5fc" fill-opacity="0.7"/></svg>`;
      }
      if (code === 3) { // 曇り
        return `<svg width="90" height="90" viewBox="0 0 90 90" fill="none"><ellipse cx="50" cy="60" rx="28" ry="16" fill="#b0bec5"/><ellipse cx="40" cy="55" rx="20" ry="12" fill="#eceff1"/></svg>`;
      }
      if (code >= 45 && code <= 48) { // 霧
        return `<svg width="90" height="90" viewBox="0 0 90 90" fill="none"><ellipse cx="45" cy="60" rx="28" ry="14" fill="#b0bec5"/><rect x="15" y="70" width="60" height="6" rx="3" fill="#cfd8dc" opacity="0.7"/><rect x="20" y="78" width="50" height="5" rx="2.5" fill="#cfd8dc" opacity="0.5"/></svg>`;
      }
      if (code >= 51 && code <= 57) { // 霧雨
        return `<svg width="90" height="90" viewBox="0 0 90 90" fill="none"><ellipse cx="50" cy="60" rx="28" ry="16" fill="#b0bec5"/><ellipse cx="40" cy="55" rx="20" ry="12" fill="#eceff1"/><g stroke="#4fc3f7" stroke-width="3"><line x1="35" y1="75" x2="35" y2="85"/><line x1="45" y1="75" x2="45" y2="85"/><line x1="55" y1="75" x2="55" y2="85"/></g></svg>`;
      }
      if (code >= 61 && code <= 67) { // 雨
        return `<svg width="90" height="90" viewBox="0 0 90 90" fill="none"><ellipse cx="50" cy="60" rx="28" ry="16" fill="#b0bec5"/><ellipse cx="40" cy="55" rx="20" ry="12" fill="#eceff1"/><g stroke="#2196f3" stroke-width="4"><line x1="35" y1="75" x2="35" y2="90"/><line x1="45" y1="75" x2="45" y2="90"/><line x1="55" y1="75" x2="55" y2="90"/></g></svg>`;
      }
      if (code >= 71 && code <= 77) { // 雪
        return `<svg width="90" height="90" viewBox="0 0 90 90" fill="none"><ellipse cx="50" cy="60" rx="28" ry="16" fill="#b0bec5"/><ellipse cx="40" cy="55" rx="20" ry="12" fill="#eceff1"/><g stroke="#90caf9" stroke-width="3"><line x1="35" y1="75" x2="35" y2="85"/><line x1="45" y1="75" x2="45" y2="85"/><line x1="55" y1="75" x2="55" y2="85"/><circle cx="35" cy="88" r="2" fill="#fff"/><circle cx="45" cy="88" r="2" fill="#fff"/><circle cx="55" cy="88" r="2" fill="#fff"/></g></svg>`;
      }
      if (code >= 80 && code <= 82) { // にわか雨
        return `<svg width="90" height="90" viewBox="0 0 90 90" fill="none"><ellipse cx="50" cy="60" rx="28" ry="16" fill="#b0bec5"/><ellipse cx="40" cy="55" rx="20" ry="12" fill="#eceff1"/><g stroke="#2196f3" stroke-width="4"><line x1="40" y1="75" x2="40" y2="90"/><line x1="50" y1="75" x2="50" y2="90"/></g></svg>`;
      }
      if (code >= 85 && code <= 86) { // にわか雪
        return `<svg width="90" height="90" viewBox="0 0 90 90" fill="none"><ellipse cx="50" cy="60" rx="28" ry="16" fill="#b0bec5"/><ellipse cx="40" cy="55" rx="20" ry="12" fill="#eceff1"/><g stroke="#90caf9" stroke-width="3"><line x1="40" y1="75" x2="40" y2="85"/><line x1="50" y1="75" x2="50" y2="85"/><circle cx="40" cy="88" r="2" fill="#fff"/><circle cx="50" cy="88" r="2" fill="#fff"/></g></svg>`;
      }
      if (code === 95) { // 雷雨
        return `<svg width="90" height="90" viewBox="0 0 90 90" fill="none"><ellipse cx="50" cy="60" rx="28" ry="16" fill="#b0bec5"/><ellipse cx="40" cy="55" rx="20" ry="12" fill="#eceff1"/><polygon points="45,70 55,70 48,85 58,85 45,100" fill="#ffd600" stroke="#ffea00" stroke-width="2"/></svg>`;
      }
      if (code === 96 || code === 99) { // 激しい雷雨
        return `<svg width="90" height="90" viewBox="0 0 90 90" fill="none"><ellipse cx="50" cy="60" rx="28" ry="16" fill="#b0bec5"/><ellipse cx="40" cy="55" rx="20" ry="12" fill="#eceff1"/><polygon points="45,70 55,70 48,85 58,85 45,100" fill="#ffd600" stroke="#ffea00" stroke-width="2"/><polygon points="55,70 65,70 58,85 68,85 55,100" fill="#ffd600" stroke="#ffea00" stroke-width="2"/></svg>`;
      }
      return "";
    }

    // 初期表示
    fetchWeather();
    // 1時間ごとに天気更新
    setInterval(fetchWeather, 60 * 60 * 1000);

    // --- 追加: 天気アイコンにホバーできらめきパーティクル ---
    function createSparkleParticles(x, y, parent) {
      // 既存のcanvasがあれば消す
      let old = parent.querySelector('.sparkle-canvas');
      if (old) old.remove();
      const canvas = document.createElement('canvas');
      canvas.width = 90;
      canvas.height = 90;
      canvas.className = 'sparkle-canvas';
      canvas.style.position = 'absolute';
      canvas.style.left = '0';
      canvas.style.top = '0';
      canvas.style.pointerEvents = 'none';
      canvas.style.zIndex = '10';
      parent.appendChild(canvas);

      const ctx = canvas.getContext('2d');
      let particles = [];
      for (let i = 0; i < 18; i++) {
        const angle = Math.random() * Math.PI * 2;
        const speed = Math.random() * 1.5 + 0.8;
        particles.push({
          x: 45, y: 45,
          vx: Math.cos(angle) * speed,
          vy: Math.sin(angle) * speed,
          r: Math.random() * 2.2 + 1.2,
          alpha: 1,
          life: Math.random() * 0.5 + 0.8
        });
      }
      let t = 0;
      function draw() {
        ctx.clearRect(0, 0, 90, 90);
        for (let p of particles) {
          ctx.save();
          ctx.globalAlpha = p.alpha;
          ctx.translate(p.x, p.y);
          ctx.rotate(t * 0.5);
          // 星型
          ctx.beginPath();
          for (let i = 0; i < 5; i++) {
            ctx.lineTo(Math.cos((18 + i * 72) / 180 * Math.PI) * p.r, -Math.sin((18 + i * 72) / 180 * Math.PI) * p.r);
            ctx.lineTo(Math.cos((54 + i * 72) / 180 * Math.PI) * p.r * 0.5, -Math.sin((54 + i * 72) / 180 * Math.PI) * p.r * 0.5);
          }
          ctx.closePath();
          ctx.fillStyle = '#fff176';
          ctx.shadowColor = '#fff176';
          ctx.shadowBlur = 8;
          ctx.fill();
          ctx.restore();

          p.x += p.vx;
          p.y += p.vy;
          p.alpha -= 0.025;
        }
        t += 0.08;
        particles = particles.filter(p => p.alpha > 0.05);
        if (particles.length > 0) {
          requestAnimationFrame(draw);
        } else {
          canvas.remove();
        }
      }
      draw();
    }

    window.addEventListener('DOMContentLoaded', () => {
      const icon = document.getElementById('weather-icon');
      if (icon) {
        icon.style.position = 'relative';
        icon.addEventListener('mouseenter', e => {
          createSparkleParticles(45, 45, icon);
        });
        icon.addEventListener('mouseleave', e => {
          let old = icon.querySelector('.sparkle-canvas');
          if (old) old.remove();
        });
      }
    });
  </script>
</body>
</html>
